<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Chat Odaları</title>
    <link rel="icon" href="data:,">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; }
        .container { display: flex; height: 100vh; }
        .sidebar {
            width: 300px;
            background: #f4f4f4;
            border-right: 1px solid #ddd;
            padding: 20px 0;
            overflow-y: auto;
        }
        .sidebar h3 { text-align: center; margin-bottom: 20px; }
        .new-chat-btn {
            display: block;
            width: 90%;
            margin: 0 auto 20px;
            padding: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .new-chat-btn:hover { background: #0056b3; }
        .chat-list { list-style: none; padding: 0; margin: 0; }
        .chat-list li {
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
        }
        .chat-list li.active, .chat-list li:hover {
            background: #e0e0e0;
        }
        .chat-area {
            flex: 1;
            padding: 30px;
            background: #fff;
            display: flex;
            flex-direction: column;
        }
        .chat-header { font-size: 1.2em; margin-bottom: 10px; }
        .messages { flex: 1; overflow-y: auto; margin-bottom: 20px; }
        .message { margin-bottom: 10px; }
        .message.me { text-align: right; }
        .send-box { display: flex; }
        .send-box input { flex: 1; padding: 10px; }
        .send-box button { padding: 10px 20px; }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 500px;
            max-width: 90%;
            border-radius: 10px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover { color: black; }
        .user-search-container {
            position: relative;
            margin-bottom: 15px;
        }
        .user-search {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
        }
        .search-result-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .search-result-item:hover { background: #f0f0f0; }
        .selected-users {
            margin-bottom: 15px;
        }
        .selected-user {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 15px;
            font-size: 12px;
        }
        .remove-user {
            margin-left: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .group-name-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .create-group-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }
        .create-group-btn:hover { background: #1e7e34; }
        .create-group-btn:disabled { 
            background: #6c757d; 
            cursor: not-allowed; 
        }
        .group-name-section {
            margin-bottom: 15px;
        }

        /* Group Details Modal Styles */
        .group-info-section {
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .group-name-display {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .group-name-display h3 {
            margin: 0;
            color: #333;
        }

        .edit-btn {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
        }

        .edit-btn:hover {
            color: #0056b3;
        }

        .members-section h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .member-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }

        .member-item.owner {
            border-left-color: #28a745;
            background: #f0f8f0;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: bold;
            color: #333;
        }

        .member-username {
            font-size: 12px;
            color: #666;
        }

        .member-role {
            font-size: 12px;
            color: #28a745;
            font-weight: bold;
        }

        .remove-member-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-member-btn:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h3>Geçmiş Konuşmalarım</h3>
            <button class="new-chat-btn" onclick="openNewChatModal()">+ Yeni Konuşma</button>
            <ul class="chat-list" id="chatList"></ul>
        </div>
        <div class="chat-area">
            <div class="chat-header" id="chatHeader" onclick="openGroupDetailsModal()" style="cursor: pointer; color: #007bff;">
                Bir sohbet seçin
            </div>
            <div class="messages" id="messages"></div>
            <form class="send-box" id="sendForm" style="display:none;">
                <input type="text" id="messageInput" placeholder="Mesajınızı yazın..." autocomplete="off" />
                <button type="submit">Gönder</button>
            </form>
        </div>
    </div>

    <div id="newChatModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeNewChatModal()">&times;</span>
            <h2 id="modalTitle">Yeni Konuşma Başlat</h2>
            
            <div class="user-search-container">
                <input type="text" id="userSearch" class="user-search" 
                       placeholder="Kullanıcı adı veya isim ara..." 
                       oninput="searchUsers(this.value)">
                <div id="searchResults" class="search-results"></div>
            </div>
            
            <div class="selected-users">
                <div id="selectedUsers"></div>
            </div>
            
            <div id="groupNameSection" class="group-name-section" style="display:none;">
                <input type="text" id="groupNameInput" class="group-name-input" 
                       placeholder="Grup adı girin...">
            </div>
            
            <button id="createGroupBtn" class="create-group-btn" 
                    onclick="handleCreateConversation()" disabled>
                <span id="createBtnText">Konuşma Oluştur</span>
            </button>
        </div>
    </div>

    <div id="groupDetailsModal" class="modal">
        <div class="modal-content" style="width: 600px; max-width: 95%;">
            <span class="close" onclick="closeGroupDetailsModal()">&times;</span>
            <h2 id="groupDetailsTitle">Grup Bilgileri</h2>
            
            <div id="groupInfo">
                    <div class="group-info-section">
                        <div class="group-name-display">
                            <h3 id="displayGroupName">Grup Adı</h3>
                            <button id="editGroupNameBtn" class="edit-btn" onclick="editGroupNameInline()" style="display:none;">
                                ✏️
                            </button>
                        </div>
                        <p><strong>Grup Yöneticisi:</strong> <span id="groupCreator">-</span></p>
                        <p><strong>Oluşturma Tarihi:</strong> <span id="groupCreatedDate">-</span></p>
                    </div>                <div class="members-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3>Grup Üyeleri</h3>
                        <button id="addMemberBtn" class="create-group-btn" style="width: auto; padding: 8px 16px; font-size: 14px; display: none;" onclick="toggleAddMemberSection()">+ Üye Ekle</button>
                    </div>
                    
                    <div id="addMemberSection" style="display: none; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; border: 1px solid #ddd;">
                        <div class="user-search-container">
                            <input type="text" id="groupUserSearch" class="user-search" 
                                   placeholder="Gruba eklenecek kullanıcıyı ara..." 
                                   oninput="searchUsersForGroup(this.value)">
                            <div id="groupSearchResults" class="search-results"></div>
                        </div>
                        <button onclick="toggleAddMemberSection()" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 3px; cursor: pointer; margin-top: 10px;">İptal</button>
                    </div>
                    
                    <div id="membersList"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const token = localStorage.getItem('chat_token');
        if (!token) {
            window.location.href = "login.html";
        }

        let selectedGroupId = null;
        let selectedUsers = [];
        let searchTimeout = null;
        let conversationStep = 'selectUsers';

        function handleUnauthorized(response) {
            if (response.status === 401) {
                localStorage.removeItem('chat_token');
                alert('Oturum süreniz dolmuş. Tekrar giriş yapmanız gerekiyor.');
                window.location.href = "login.html";true;
                return 
            }
            return false;
        }

        async function loadChatRooms() {
            try {
                const response = await fetch('http://localhost:5500/api/chatSidebar', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json','Authorization': 'Bearer ' + token }
                });
                
                if (handleUnauthorized(response)) return;
                
                if (response.ok) {
                    const chatRooms = await response.json();
                    const chatList = document.getElementById('chatList');
                    chatList.innerHTML = '';
                    chatRooms.forEach(room => {
                        const li = document.createElement('li');
                        li.textContent = room.groupName //+ (room.lastMessageContent ? ' - ' + room.lastMessageContent : '');
                        li.onclick = function(event) {
                            selectChatRoom(room.groupId, room.groupName, event);
                        };
                        chatList.appendChild(li);
                    });
                } else {
                    document.getElementById('chatList').innerHTML = '<li>Konuşma bulunamadı.</li>';
                }
            } catch (error) {
                console.error('Chat odaları yüklenirken hata:', error);
                document.getElementById('chatList').innerHTML = '<li>Bağlantı hatası.</li>';
            }
        }

        async function selectChatRoom(groupId, groupName, event) {
            selectedGroupId = groupId;
            const chatHeader = document.getElementById('chatHeader');
            chatHeader.textContent = groupName;
            chatHeader.style.cursor = 'pointer';
            chatHeader.style.color = '#007bff';
            chatHeader.onclick = () => openGroupDetailsModal();
            
            document.querySelectorAll('.chat-list li').forEach(li => li.classList.remove('active'));
            if(event && event.target) event.target.classList.add('active');
            document.getElementById('sendForm').style.display = 'flex';

            try {
                const response = await fetch(`http://localhost:5500/api/groups/${groupId}/messages`, {
                    method: 'GET',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token 
                    }
                });
                
                if (handleUnauthorized(response)) return;
                
                const messagesDiv = document.getElementById('messages');
                messagesDiv.innerHTML = '';
                
                if (response.ok) {
                    const messages = await response.json();
                    messages.forEach(msg => {
                        const div = document.createElement('div');
                        div.className = 'message' + (msg.isMine ? ' me' : '');
                        div.textContent = msg.senderName + ': ' + msg.content;
                        messagesDiv.appendChild(div);
                    });
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                } else {
                    messagesDiv.innerHTML = '<div>Mesajlar yüklenirken hata oluştu.</div>';
                }
            } catch (error) {
                console.error('Mesajlar yüklenirken hata:', error);
                document.getElementById('messages').innerHTML = '<div>Bağlantı hatası.</div>';
            }
        }

        document.getElementById('sendForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const content = document.getElementById('messageInput').value.trim();
            if (!content || !selectedGroupId) return;
            
            try {
                const response = await fetch(`http://localhost:5500/api/groups/${selectedGroupId}/messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ content: content })
                });
                
                if (handleUnauthorized(response)) return;
                
                if (response.ok) {
                    document.getElementById('messageInput').value = '';
                    selectChatRoom(selectedGroupId, document.getElementById('chatHeader').textContent);
                } else {
                    const error = await response.text();
                    alert('Mesaj gönderilemedi: ' + error);
                }
            } catch (error) {
                console.error('Mesaj gönderme hatası:', error);
                alert('Bağlantı hatası: ' + error.message);
            }
        });

        loadChatRooms();

        function openNewChatModal() {
            document.getElementById('newChatModal').style.display = 'block';
            resetModal();
        }

        function closeNewChatModal() {
            document.getElementById('newChatModal').style.display = 'none';
            resetModal();
        }

        function resetModal() {
            document.getElementById('userSearch').value = '';
            document.getElementById('groupNameInput').value = '';
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('groupNameSection').style.display = 'none';
            document.getElementById('userSearch').style.display = 'block';
            document.querySelector('.user-search-container').style.display = 'block';
            document.getElementById('modalTitle').textContent = 'Yeni Konuşma Başlat';
            selectedUsers = [];
            conversationStep = 'selectUsers';
            updateSelectedUsersDisplay();
            updateCreateButtonState();
        }

        async function searchUsers(searchTerm) {
            clearTimeout(searchTimeout);
            
            if (searchTerm.length < 1) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`http://localhost:5500/api/chat/search-users?searchTerm=${encodeURIComponent(searchTerm)}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        }
                    });

                    if (handleUnauthorized(response)) return;

                    if (response.ok) {
                        const users = await response.json();
                        displaySearchResults(users);
                    }
                } catch (error) {
                    console.error('Kullanıcı arama hatası:', error);
                }
            }, 300);
        }

        function displaySearchResults(users) {
            const searchResults = document.getElementById('searchResults');
            searchResults.innerHTML = '';

            const filteredUsers = users.filter(user => 
                !selectedUsers.find(selectedUser => selectedUser.userId === user.userId)
            );

            if (filteredUsers.length === 0) {
                searchResults.style.display = 'none';
                return;
            }

            filteredUsers.forEach(user => {
                const div = document.createElement('div');
                div.className = 'search-result-item';
                div.textContent = user.displayName;
                div.onclick = () => selectUser(user);
                searchResults.appendChild(div);
            });

            searchResults.style.display = 'block';
        }

        function selectUser(user) {
            if (selectedUsers.find(u => u.userId === user.userId)) {
                return;
            }

            selectedUsers.push(user);
            updateSelectedUsersDisplay();
            updateCreateButtonState();
            
            document.getElementById('userSearch').value = '';
            document.getElementById('searchResults').style.display = 'none';
        }

        function removeUser(userId) {
            selectedUsers = selectedUsers.filter(u => u.userId !== userId);
            updateSelectedUsersDisplay();
            updateCreateButtonState();
            
            const searchInput = document.getElementById('userSearch');
            if (searchInput.value.trim().length >= 2) {
                searchUsers(searchInput.value);
            }
        }

        function updateSelectedUsersDisplay() {
            const container = document.getElementById('selectedUsers');
            const usersHtml = selectedUsers.map(user => `
                <span class="selected-user">
                    ${user.displayName}
                    <span class="remove-user" onclick="removeUser(${user.userId})">&times;</span>
                </span>
            `).join('');
            
            container.innerHTML = '<h4>Seçilen Kullanıcılar:</h4>' + usersHtml;
        }

        function updateCreateButtonState() {
            const createBtn = document.getElementById('createGroupBtn');
            const createBtnText = document.getElementById('createBtnText');
            
            if (conversationStep === 'selectUsers') {
                createBtn.disabled = selectedUsers.length === 0;
                if (selectedUsers.length === 1) {
                    createBtnText.textContent = 'Tekil Konuşma Başlat';
                } else if (selectedUsers.length > 1) {
                    createBtnText.textContent = 'Devam Et';
                } else {
                    createBtnText.textContent = 'Konuşma Oluştur';
                }
            } else if (conversationStep === 'enterGroupName') {
                const groupName = document.getElementById('groupNameInput').value.trim();
                createBtn.disabled = groupName === '';
                createBtnText.textContent = 'Grup Konuşması Oluştur';
            }
        }

        document.getElementById('groupNameInput').addEventListener('input', updateCreateButtonState);
        
        document.getElementById('groupNameInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !document.getElementById('createGroupBtn').disabled) {
                handleCreateConversation();
            }
        });

        async function handleCreateConversation() {
            if (conversationStep === 'selectUsers') {
                if (selectedUsers.length === 1) {
                    await createConversation();
                } else if (selectedUsers.length > 1) {
                    conversationStep = 'enterGroupName';
                    document.getElementById('modalTitle').textContent = 'Grup Adı Belirleyin';
                    document.getElementById('groupNameSection').style.display = 'block';
                    updateCreateButtonState();
                    setTimeout(() => {
                        document.getElementById('groupNameInput').focus();
                    }, 100);
                }
            } else if (conversationStep === 'enterGroupName') {
                await createConversation();
            }
        }

        async function createConversation() {
            const userIds = selectedUsers.map(u => u.userId);
            let groupName;

            if (selectedUsers.length === 1) {
                groupName = "Private Chat";
            } else {
                groupName = document.getElementById('groupNameInput').value.trim();
                if (!groupName) {
                    alert('Grup adı girmelisiniz.');
                    return;
                }
            }

            if (userIds.length === 0) {
                alert('En az bir kullanıcı seçmelisiniz.');
                return;
            }

            try {
                const response = await fetch('http://localhost:5500/api/chat/create-group', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({
                        groupName: groupName,
                        userIds: userIds
                    })
                });

                if (handleUnauthorized(response)) return;

                if (response.ok) {
                    const result = await response.json();
                    closeNewChatModal();
                    
                    await loadChatRooms();
                    
                    selectChatRoom(result.groupId, result.groupName);
                    
                    if (selectedUsers.length === 1) {
                        alert('Tekil konuşma başlatıldı!');
                    } else {
                        alert(result.message);
                    }
                } else {
                    const error = await response.text();
                    alert('Konuşma oluşturulamadı: ' + error);
                }
            } catch (error) {
                console.error('Konuşma oluşturma hatası:', error);
                alert('Bağlantı hatası: ' + error.message);
            }
        }

        async function openGroupDetailsModal() {
            if (!selectedGroupId) {
                alert('Lütfen önce bir grup seçin.');
                return;
            }

            try {
                const response = await fetch(`http://localhost:5500/api/chat/group/${selectedGroupId}/details`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (handleUnauthorized(response)) return;

                if (response.ok) {
                    const groupDetails = await response.json();
                    displayGroupDetails(groupDetails);
                    document.getElementById('groupDetailsModal').style.display = 'block';
                } else {
                    alert('Grup bilgileri alınamadı.');
                }
            } catch (error) {
                console.error('Grup bilgileri alınırken hata:', error);
                alert('Bağlantı hatası: ' + error.message);
            }
        }

        function displayGroupDetails(groupDetails) {
            document.getElementById('displayGroupName').textContent = groupDetails.groupName;
            document.getElementById('groupCreator').textContent = groupDetails.createdByName || 'Bilinmeyen';
            
            const createdDate = new Date(groupDetails.createdDate);
            document.getElementById('groupCreatedDate').textContent = createdDate.toLocaleDateString('tr-TR');

            const editBtn = document.getElementById('editGroupNameBtn');
            const addMemberBtn = document.getElementById('addMemberBtn');
            
            const isRealPrivateChat = groupDetails.members.length === 2 && 
                                    (groupDetails.originalGroupName === "Private Chat" || 
                                     groupDetails.originalGroupName === groupDetails.groupName);
            
            if (groupDetails.isCurrentUserOwner && !isRealPrivateChat) {
                editBtn.style.display = 'inline-block';
                addMemberBtn.style.display = 'inline-block';
            } else {
                editBtn.style.display = 'none';
                addMemberBtn.style.display = 'none';
            }

            const membersList = document.getElementById('membersList');
            membersList.innerHTML = '';
            
            currentGroupMembers = groupDetails.members;

            groupDetails.members.forEach(member => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'member-item' + (member.isOwner ? ' owner' : '');

                const memberInfo = document.createElement('div');
                memberInfo.className = 'member-info';

                const memberName = document.createElement('div');
                memberName.className = 'member-name';
                memberName.textContent = member.displayName;

                const memberUsername = document.createElement('div');
                memberUsername.className = 'member-username';
                memberUsername.textContent = '@' + member.userName;

                memberInfo.appendChild(memberName);
                memberInfo.appendChild(memberUsername);

                if (member.isOwner) {
                    const roleSpan = document.createElement('div');
                    roleSpan.className = 'member-role';
                    roleSpan.textContent = 'Grup Sahibi';
                    memberInfo.appendChild(roleSpan);
                }

                memberDiv.appendChild(memberInfo);

                const isPrivateChatForRemove = groupDetails.members.length === 2 && 
                                             (groupDetails.originalGroupName === "Private Chat" || 
                                              groupDetails.originalGroupName === groupDetails.groupName);
                                              
                if (groupDetails.isCurrentUserOwner && !member.isOwner && !isPrivateChatForRemove) {
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-member-btn';
                    removeBtn.textContent = 'Çıkar';
                    removeBtn.onclick = () => removeMemberFromGroup(member.userId, member.displayName);
                    memberDiv.appendChild(removeBtn);
                }

                membersList.appendChild(memberDiv);
            });

            const modalTitle = document.getElementById('groupDetailsTitle');
            const isPrivateChatForTitle = groupDetails.members.length === 2 && 
                                        (groupDetails.originalGroupName === "Private Chat" || 
                                         groupDetails.originalGroupName === groupDetails.groupName);
                                     
            if (isPrivateChatForTitle) {
                modalTitle.textContent = 'Konuşma Bilgileri';
            } else {
                modalTitle.textContent = 'Grup Bilgileri';
            }
        }

        function closeGroupDetailsModal() {
            document.getElementById('groupDetailsModal').style.display = 'none';
            document.getElementById('addMemberSection').style.display = 'none';
            document.getElementById('groupUserSearch').value = '';
            document.getElementById('groupSearchResults').style.display = 'none';
        }

        function toggleAddMemberSection() {
            const addMemberSection = document.getElementById('addMemberSection');
            if (addMemberSection.style.display === 'none') {
                addMemberSection.style.display = 'block';
                document.getElementById('groupUserSearch').focus();
            } else {
                addMemberSection.style.display = 'none';
                document.getElementById('groupUserSearch').value = '';
                document.getElementById('groupSearchResults').style.display = 'none';
            }
        }

        let groupSearchTimeout = null;
        let currentGroupMembers = [];

        async function searchUsersForGroup(searchTerm) {
            clearTimeout(groupSearchTimeout);
            
            if (searchTerm.length < 2) {
                document.getElementById('groupSearchResults').style.display = 'none';
                return;
            }

            groupSearchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`http://localhost:5500/api/chat/search-users?searchTerm=${encodeURIComponent(searchTerm)}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        }
                    });

                    if (handleUnauthorized(response)) return;

                    if (response.ok) {
                        const users = await response.json();
                        displayGroupSearchResults(users);
                    }
                } catch (error) {
                    console.error('Grup için kullanıcı arama hatası:', error);
                }
            }, 300);
        }

        function displayGroupSearchResults(users) {
            const searchResults = document.getElementById('groupSearchResults');
            searchResults.innerHTML = '';

            const filteredUsers = users.filter(user => 
                !currentGroupMembers.find(member => member.userId === user.userId)
            );

            if (filteredUsers.length === 0) {
                searchResults.style.display = 'none';
                return;
            }

            filteredUsers.forEach(user => {
                const div = document.createElement('div');
                div.className = 'search-result-item';
                div.textContent = user.displayName;
                div.onclick = () => addUserToGroup(user);
                searchResults.appendChild(div);
            });

            searchResults.style.display = 'block';
        }

        async function addUserToGroup(user) {
            if (!confirm(`${user.displayName} adlı kullanıcıyı gruba eklemek istediğinizden emin misiniz?`)) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:5500/api/chat/add-user-to-group/${selectedGroupId}/${user.userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (handleUnauthorized(response)) return;

                if (response.ok) {
                    alert(`${user.displayName} gruba eklendi.`);
                    toggleAddMemberSection(); // Arama bölümünü kapat
                    openGroupDetailsModal(); // Grup detaylarını yenile
                    loadChatRooms(); // Chat listesini yenile
                } else {
                    const error = await response.text();
                    alert('Hata: ' + error);
                }
            } catch (error) {
                console.error('Kullanıcı gruba eklenirken hata:', error);
                alert('Bağlantı hatası: ' + error.message);
            }
        }

        async function removeMemberFromGroup(userId, displayName) {
            if (!confirm(`${displayName} adlı kullanıcıyı gruptan çıkarmak istediğinizden emin misiniz?`)) {
                return;
            }

            try {
                const response = await fetch(`http://localhost:5500/api/chat/remove-user-from-group/${selectedGroupId}/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (handleUnauthorized(response)) return;

                if (response.ok) {
                    alert(`${displayName} gruptan çıkarıldı.`);
                    openGroupDetailsModal();
                    loadChatRooms();
                } else {
                    const error = await response.text();
                    alert('Hata: ' + error);
                }
            } catch (error) {
                console.error('Kullanıcı gruptan çıkarılırken hata:', error);
                alert('Bağlantı hatası: ' + error.message);
            }
        }

        function editGroupNameInline() {
            const currentName = document.getElementById('displayGroupName').textContent;
            const newName = prompt('Yeni grup adını girin:', currentName);
            
            if (newName && newName.trim() !== '' && newName.trim() !== currentName) {
                updateGroupName(newName.trim());
            }
        }

        async function updateGroupName(newName) {
            try {
                const response = await fetch(`http://localhost:5500/api/chat/group/${selectedGroupId}/name`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify({ newName: newName })
                });

                if (handleUnauthorized(response)) return;

                if (response.ok) {
                    // Başarılı güncelleme
                    document.getElementById('displayGroupName').textContent = newName;
                    
                    // Chat header'daki grup adını güncelle
                    // Birebir konuşmalarda orijinal mantığı koru
                    const currentGroupDetails = await getCurrentGroupDetails();
                    if (currentGroupDetails && !currentGroupDetails.isPrivateChat) {
                        document.getElementById('chatHeader').textContent = newName;
                    }
                    
                    // Chat listesini yenile
                    loadChatRooms();
                    alert('Grup adı başarıyla güncellendi.');
                } else {
                    const error = await response.text();
                    alert('Hata: ' + error);
                }
            } catch (error) {
                console.error('Grup adı güncellenirken hata:', error);
                alert('Bağlantı hatası: ' + error.message);
            }
        }

        async function getCurrentGroupDetails() {
            try {
                const response = await fetch(`http://localhost:5500/api/chat/group/${selectedGroupId}/details`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (response.ok) {
                    return await response.json();
                }
                return null;
            } catch (error) {
                console.error('Grup bilgileri alınırken hata:', error);
                return null;
            }
        }

        // Modal dışına tıklandığında kapat
        window.onclick = function(event) {
            const modal = document.getElementById('newChatModal');
            const groupModal = document.getElementById('groupDetailsModal');
            
            if (event.target === modal) {
                closeNewChatModal();
            } else if (event.target === groupModal) {
                closeGroupDetailsModal();
            }
        };
    </script>
</body>
</html>